name: OIDC Debug

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Get ID token and print claims
        shell: bash
        run: |
          set -e

          echo "Requesting OIDC token..."
          resp=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com")

          echo "Raw response: $resp"

          id_token=$(echo "$resp" | jq -r '.value')

          # 1) coger la parte payload del JWT (header.payload.signature)
          payload=$(echo "$id_token" | cut -d '.' -f 2)

          # 2) a√±adir padding para base64
          pad=$(( (4 - ${#payload} % 4) % 4 ))
          if [ "$pad" -ne 0 ]; then
            payload="${payload}$(printf '=%.0s' $(seq 1 $pad))"
          fi

          echo "Decoded payload:"
          echo "$payload" | base64 -d
