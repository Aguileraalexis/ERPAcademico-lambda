name: OIDC Debug

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Get and decode OIDC token
        shell: bash
        run: |
          set -e

          echo "Requesting OIDC token..."
          resp=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com")

          echo "Raw response (value aparecer√° como *** en logs, es normal): $resp"

          id_token=$(echo "$resp" | jq -r '.value')

          python - "$id_token" << 'PY'
import sys, base64, json

token = sys.argv[1]
# token = header.payload.signature
payload_b64 = token.split(".")[1]
padding = "=" * (-len(payload_b64) % 4)
payload = base64.urlsafe_b64decode(payload_b64 + padding).decode()
print(payload)
PY
