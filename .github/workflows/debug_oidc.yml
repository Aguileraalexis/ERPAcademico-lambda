name: OIDC Debug

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Get ID token and print claims
        run: |
          echo "Requesting OIDC token..."
          RESP=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com")
          echo "Raw response: $RESP"

          ID_TOKEN=$(echo "$RESP" | jq -r '.value')
          export ID_TOKEN

          echo "Decoded payload:"
          python - << 'PY'
            import os, base64, json
            tok = os.environ["ID_TOKEN"]
            payload_b64 = tok.split(".")[1]
            payload_b64 += "=" * (-len(payload_b64) % 4)
            payload = base64.urlsafe_b64decode(payload_b64.encode()).decode()
            print(payload)
            PY
